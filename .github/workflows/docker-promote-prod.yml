name: Docker Promote to Prod

on:
    workflow_call:
        inputs:
            version:
                description: 'Image version to promote (e.g. 1.0.0-abc1234)'
                required: true
                type: string
            app_name:
                description: 'Application name (defaults to repository name)'
                required: false
                type: string
                default: ''
            docker_registry:
                description: 'Docker registry URL'
                required: false
                type: string
                default: '10.20.0.102:5000'
            runs_on:
                description: 'Runner label'
                required: false
                type: string
                default: 't630'
            timeout_minutes:
                description: 'Job timeout in minutes'
                required: false
                type: number
                default: 15
            vault_addr:
                description: 'Vault server address'
                required: false
                type: string
                default: 'http://10.20.0.123:8200'
            vault_secret_path:
                description: 'Vault secret path for credentials'
                required: false
                type: string
                default: 'secret/data/github/credentials'
            vault_kubeconfig_path:
                description: 'Vault path for kubeconfig'
                required: false
                type: string
                default: 'secret/data/bc-apps/kubeconfig'
            k8s_namespace:
                description: 'Kubernetes prod namespace'
                required: false
                type: string
                default: 'bc-prod'
            k8s_deployment:
                description: 'Kubernetes deployment name (defaults to app_name)'
                required: false
                type: string
                default: ''
            k8s_container:
                description: 'Kubernetes container name (defaults to app_name)'
                required: false
                type: string
                default: ''
        secrets:
            VAULT_ROLE_ID:
                description: 'Vault AppRole role ID'
                required: false
            VAULT_SECRET_ID:
                description: 'Vault AppRole secret ID'
                required: false

env:
    APP_NAME: ${{ inputs.app_name || github.event.repository.name }}
    DOCKER_REGISTRY: ${{ inputs.docker_registry }}
    VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID || '60ddcafc-3ed1-34be-099b-929dc69e0e37' }}
    VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID || '3d6b06b6-1a41-4563-0fca-7b9f361ef5a4' }}
    K8S_DEPLOYMENT: ${{ inputs.k8s_deployment || inputs.app_name || github.event.repository.name }}
    K8S_CONTAINER: ${{ inputs.k8s_container || inputs.app_name || github.event.repository.name }}

jobs:
    promote:
        name: Promote to Prod
        runs-on: ${{ inputs.runs_on }}
        timeout-minutes: ${{ inputs.timeout_minutes }}

        steps:
            -   name: Import Secrets from Vault
                uses: hashicorp/vault-action@v3
                with:
                    url: ${{ inputs.vault_addr }}
                    method: approle
                    roleId: ${{ env.VAULT_ROLE_ID }}
                    secretId: ${{ env.VAULT_SECRET_ID }}
                    secrets: |
                        ${{ inputs.vault_secret_path }} slack_webhook_url | SLACK_WEBHOOK_URL ;
                        ${{ inputs.vault_kubeconfig_path }} kubeconfig | KUBECONFIG_DATA

            -   name: Update Kubernetes prod deployment
                run: |
                    mkdir -p $HOME/.kube
                    echo "${{ env.KUBECONFIG_DATA }}" > $HOME/.kube/config
                    chmod 600 $HOME/.kube/config
                    kubectl set image deployment/${{ env.K8S_DEPLOYMENT }} \
                        ${{ env.K8S_CONTAINER }}=${{ env.DOCKER_REGISTRY }}/${{ env.APP_NAME }}:${{ inputs.version }} \
                        -n ${{ inputs.k8s_namespace }}
                    kubectl rollout status deployment/${{ env.K8S_DEPLOYMENT }} -n ${{ inputs.k8s_namespace }} --timeout=120s

            -   name: Summary
                run: |
                    echo "## âœ… Promoted to Prod" >> $GITHUB_STEP_SUMMARY
                    echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                    echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                    echo "| Version | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
                    echo "| Image | \`${{ env.DOCKER_REGISTRY }}/${{ env.APP_NAME }}:${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
                    echo "| Namespace | \`${{ inputs.k8s_namespace }}\` |" >> $GITHUB_STEP_SUMMARY
                    echo "| Triggered by | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY

            -   name: Slack - Success
                if: success()
                run: |
                    curl -X POST -H 'Content-type: application/json' \
                        --data '{
                            "blocks": [
                                {
                                    "type": "header",
                                    "text": {"type": "plain_text", "text": "ðŸš€ ${{ env.APP_NAME }} - Promoted to Prod", "emoji": true}
                                },
                                {
                                    "type": "section",
                                    "fields": [
                                        {"type": "mrkdwn", "text": "*Repository:*\n${{ github.repository }}"},
                                        {"type": "mrkdwn", "text": "*Version:*\n${{ inputs.version }}"},
                                        {"type": "mrkdwn", "text": "*Namespace:*\n${{ inputs.k8s_namespace }}"},
                                        {"type": "mrkdwn", "text": "*Promoted by:*\n${{ github.actor }}"}
                                    ]
                                },
                                {
                                    "type": "section",
                                    "text": {"type": "mrkdwn", "text": "*Image:*\n`${{ env.DOCKER_REGISTRY }}/${{ env.APP_NAME }}:${{ inputs.version }}`"}
                                },
                                {
                                    "type": "actions",
                                    "elements": [
                                        {"type": "button", "text": {"type": "plain_text", "text": "View Run", "emoji": true}, "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}
                                    ]
                                }
                            ]
                        }' \
                        ${{ env.SLACK_WEBHOOK_URL }}

            -   name: Slack - Failure
                if: failure()
                run: |
                    curl -X POST -H 'Content-type: application/json' \
                        --data '{
                            "blocks": [
                                {
                                    "type": "header",
                                    "text": {"type": "plain_text", "text": "ðŸ”´ ${{ env.APP_NAME }} - Prod Promotion Failed", "emoji": true}
                                },
                                {
                                    "type": "section",
                                    "fields": [
                                        {"type": "mrkdwn", "text": "*Repository:*\n${{ github.repository }}"},
                                        {"type": "mrkdwn", "text": "*Version:*\n${{ inputs.version }}"},
                                        {"type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}"}
                                    ]
                                },
                                {
                                    "type": "actions",
                                    "elements": [
                                        {"type": "button", "text": {"type": "plain_text", "text": "View Logs", "emoji": true}, "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}
                                    ]
                                }
                            ]
                        }' \
                        ${{ env.SLACK_WEBHOOK_URL }}
